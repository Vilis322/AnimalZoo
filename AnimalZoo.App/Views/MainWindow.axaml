<?xml version="1.0" encoding="utf-8"?>
<Window
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    x:Class="AnimalZoo.App.Views.MainWindow"
    Width="980" Height="720"
    Title="Animal Zoo"
    mc:Ignorable="d">

  <Grid RowDefinitions="Auto,* ,Auto" ColumnDefinitions="*,2*">
    <!-- HEADER -->
    <TextBlock Grid.ColumnSpan="2" Margin="12" FontSize="20" FontWeight="SemiBold"
               Text="Animal Zoo" />

    <!-- LEFT: Animals list + actions -->
    <StackPanel Grid.Row="1" Grid.Column="0" Margin="12" Spacing="8">
      <TextBlock Text="Animals" FontWeight="SemiBold" />
      <!-- Автовысота + встроенный скролл у ListBox; ограничим по максимуму чтобы верстка не разъехалась -->
      <ListBox ItemsSource="{Binding Animals}"
               SelectedItem="{Binding SelectedAnimal}"
               MaxHeight="380">
        <ListBox.ItemTemplate>
          <DataTemplate>
            <Border BorderBrush="#333" BorderThickness="0,0,0,1" Padding="4,6">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="{Binding Name}" />
                <TextBlock Text="(" Opacity="0.6"/>
                <TextBlock Text="{Binding Age}" Opacity="0.6"/>
                <TextBlock Text=" y.o.)" Opacity="0.6"/>
              </StackPanel>
            </Border>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>

      <StackPanel Orientation="Horizontal" Spacing="8">
        <Button Content="Add Animal" Click="OnAddAnimalClick" />
        <Button Content="Remove Animal" Command="{Binding RemoveAnimalCommand}" />
      </StackPanel>

      <!-- Enclosure actions -->
      <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
        <Button Content="Drop Food (feed all)" Command="{Binding DropFoodCommand}" />
        <Button Content="Refresh Stats (reset to Hungry)" Command="{Binding RefreshStatsCommand}" />
      </StackPanel>
    </StackPanel>

    <!-- RIGHT: Details + Actions + Stats -->
    <StackPanel Grid.Row="1" Grid.Column="1" Margin="12" Spacing="10">
      <TextBlock Text="Details" FontWeight="SemiBold" />

      <!-- NEW: toggle IDs panel -->
      <Button Content="Show IDs" Command="{Binding ToggleIdListCommand}" HorizontalAlignment="Left"/>

      <!-- NEW: IDs panel (scrollable, collapsible) -->
      <Border IsVisible="{Binding IsIdListVisible}"
              BorderBrush="#444" BorderThickness="1" CornerRadius="6"
              Padding="8" Background="#101010" >
        <Grid RowDefinitions="Auto,*">
          <TextBlock Text="Animal IDs" FontWeight="SemiBold" Margin="0,0,0,6"/>
          <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" MaxHeight="180">
            <ItemsControl ItemsSource="{Binding AnimalIds}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border BorderBrush="#333" BorderThickness="0,0,0,1" Padding="2,4">
                    <TextBlock Text="{Binding .}" TextWrapping="Wrap"/>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>
        </Grid>
      </Border>

      <!-- Animal image -->
      <Border Padding="6" BorderBrush="#EEE" BorderThickness="1" CornerRadius="6" Margin="0,0,0,6">
        <Image Source="{Binding CurrentImage}"
               Height="160"
               Stretch="Uniform"
               HorizontalAlignment="Center"/>
      </Border>

      <Border Padding="10" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6">
        <Grid ColumnDefinitions="Auto,10,*" RowDefinitions="Auto,Auto,Auto">
          <TextBlock Grid.Row="0" Grid.Column="0" Text="Name:"/>
          <TextBlock Grid.Row="0" Grid.Column="2" Text="{Binding SelectedAnimal.Name}"/>

          <TextBlock Grid.Row="1" Grid.Column="0" Text="Age:"/>
          <TextBlock Grid.Row="1" Grid.Column="2" Text="{Binding SelectedAnimal.Age}"/>

          <TextBlock Grid.Row="2" Grid.Column="0" Text="State:"/>
          <TextBlock Grid.Row="2" Grid.Column="2" Text="{Binding SelectedAnimal.DisplayState}"/>
        </Grid>
      </Border>

      <StackPanel Orientation="Horizontal" Spacing="8">
        <Button Content="Make Sound" Command="{Binding MakeSoundCommand}" />
        <Button Content="Crazy Action" Command="{Binding CrazyActionCommand}" />
        <Button Content="Toggle Fly (Flyable)" Command="{Binding ToggleFlyCommand}" />
      </StackPanel>

      <!-- FEED with embedded clear button -->
      <Grid ColumnDefinitions="Auto,Auto" RowDefinitions="Auto">
        <Grid>
          <TextBox Width="260"
                   Watermark="Food to feed..."
                   Text="{Binding FoodInput, Mode=TwoWay}" />
          <Button Content="×"
                  HorizontalAlignment="Right"
                  VerticalAlignment="Center"
                  Margin="0,0,6,0"
                  Padding="6,0"
                  Command="{Binding ClearFoodCommand}"
                  ToolTip.Tip="Clear input" />
        </Grid>
        <Button Grid.Column="1"
                Content="Feed (selected)"
                Margin="8,0,0,0"
                Command="{Binding FeedCommand}" />
      </Grid>

      <!-- LOG action row -->
      <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="8" Margin="0,10,0,0">
        <TextBlock Text="Log" FontWeight="SemiBold" />
        <Button Content="Delete selected"
                Command="{Binding RemoveLogEntryByValueCommand}"
                CommandParameter="{Binding SelectedLogEntry}"/>
        <Button Content="Clear log" Command="{Binding ClearLogCommand}" />
      </StackPanel>

      <!-- LOG list -->
      <ListBox ItemsSource="{Binding LogEntries}"
               SelectedItem="{Binding SelectedLogEntry}"
               MaxHeight="160">
        <ListBox.ItemTemplate>
          <DataTemplate>
            <Border BorderBrush="#333" BorderThickness="0,0,0,1" Padding="6,6">
              <TextBlock Text="{Binding .}" TextWrapping="Wrap" />
            </Border>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>

      <!-- STATS -->
      <TextBlock Text="Stats (LINQ)" FontWeight="SemiBold" Margin="0,8,0,0"/>

      <!-- Scrollable stats block -->
      <Border Padding="8" BorderBrush="#EEE" BorderThickness="1" CornerRadius="6" MaxHeight="260">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Spacing="6">

            <!-- Header -->
            <Grid ColumnDefinitions="2*,*,*" Margin="0,0,0,4">
              <TextBlock Grid.Column="0" Text="Type" FontWeight="SemiBold"/>
              <TextBlock Grid.Column="1" Text="Count" FontWeight="SemiBold"/>
              <TextBlock Grid.Column="2" Text="Average age" FontWeight="SemiBold"/>
            </Grid>

            <!-- Rows with horizontal separators -->
            <ItemsControl ItemsSource="{Binding ByTypeStats}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border BorderBrush="#333" BorderThickness="0,0,0,1" Padding="2,4">
                    <Grid ColumnDefinitions="2*,*,*">
                      <TextBlock Grid.Column="0" Text="{Binding Type}"/>
                      <TextBlock Grid.Column="1" Text="{Binding Count}"/>
                      <TextBlock Grid.Column="2" Text="{Binding AverageAge, StringFormat='{}{0:F1}'}"/>
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Hungry list -->
            <TextBlock Text="Hungry animals (older first):" FontWeight="SemiBold" Margin="0,8,0,0"/>
            <ItemsControl ItemsSource="{Binding HungryStats}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border BorderBrush="#333" BorderThickness="0,0,0,1" Padding="2,4">
                    <TextBlock Text="{Binding .}" TextWrapping="Wrap"/>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Oldest -->
            <TextBlock Text="Oldest animal:" FontWeight="SemiBold" Margin="0,8,0,0"/>
            <Border BorderBrush="#333" BorderThickness="0,0,0,1" Padding="2,4">
              <TextBlock Text="{Binding OldestStat}"/>
            </Border>

          </StackPanel>
        </ScrollViewer>
      </Border>
    </StackPanel>

    <!-- FOOTER -->
    <TextBlock Grid.Row="2" Grid.ColumnSpan="2" Margin="12"
               Opacity="0.7"
               Text="Tips: Drop Food feeds all (guarded from double-click). Refresh Stats resets all to Hungry. Lists and stats are scrollable." />
  </Grid>
</Window>
